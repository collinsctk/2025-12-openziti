### 创建/opt/ziti-controller/.env
```shell
mkdir -p /opt/ziti-controller
cat > /opt/ziti-controller/.env << 'EOF'
# Controller 管理口（控制平面）地址
ZITI_CTRL_ADVERTISED_ADDRESS=ziti-controller.mingjiaocf.com
ZITI_CTRL_ADVERTISED_PORT=6262

# Controller 边缘口（Edge API）地址
ZITI_CTRL_EDGE_ADVERTISED_ADDRESS=ziti-controller.mingjiaocf.com
ZITI_CTRL_EDGE_ADVERTISED_PORT=1280

# 管理员账号和密码
ZITI_USER=admin
ZITI_PWD=Cisc0123
EOF
```

### 创建docker-compose.yaml
```shell
cat > /opt/ziti-controller/docker-compose.yaml << 'EOF'
services:
  ziti-controller:
    image: openziti/ziti-controller:latest
    container_name: ziti-controller
    env_file:
      - ./.env
    # 新增下面这段，引导生成 PKI、数据库和配置
    environment:
      - ZITI_BOOTSTRAP=true
      - ZITI_BOOTSTRAP_PKI=true
      - ZITI_BOOTSTRAP_DATABASE=true
      - ZITI_BOOTSTRAP_CONFIG=true
    ports:
      - "1280:1280/tcp"  # Edge API（客户端/CLI 登陆）
      - "6262:6262/tcp"  # 控制平面（Edge Router 注册）
    volumes:
      - ./ziti-controller-data:/persistent
    restart: unless-stopped
EOF
```

### 拉起容器
```shell
cd /opt/ziti-controller/
docker compose up -d

```

### 安装ziti cli工具
```shell
curl -sS https://get.openziti.io/install.bash | bash -s openziti

```
### 测试登录
```shell
[root@ip-10-1-1-38 ziti-controller]# ziti edge login ziti-controller.mingjiaocf.com:6262 -u admin -p Cisc0123 -y
Untrusted certificate authority retrieved from server
Verified that server supplied certificates are trusted by server
Server supplied 2 certificates
Server certificate chain written to /root/.config/ziti/certs/ziti-controller.mingjiaocf.com
Token: 2adf3386-d3bb-4a8c-8f7b-30c070cf7672
Saving identity 'default' to /root/.config/ziti/ziti-cli.json

```

### 创建Edge Router的JWT
```shell
ziti edge create edge-router aws-edge-router \
  --role-attributes "public,aws-host" \
  --jwt-output-file aws-router.jwt

scp aws-router.jwt root@ziti-edge-router-1.mingjiaocf.com:/root/aws-router.jwt

```


### 配置策略
```shell
ziti edge create config caddy-intercept intercept.v1 '{
  "protocols": ["tcp"],
  "addresses": ["ziti-service.mingjiaocf.com"],
  "portRanges": [{ "low": 443, "high": 443 }]
}'

ziti edge create config caddy-host host.v1 '{
  "protocol":"tcp",
  "address":"127.0.0.1",
  "port":443
}'

ziti edge list configs

ziti edge create service caddy-service \
  --configs caddy-intercept,caddy-host

ziti edge create service-policy caddy-dial Dial \
  --service-roles "@caddy-service" \
  --identity-roles "#nginx-clients"

ziti edge create service-edge-router-policy caddy-bind \
  --service-roles "@caddy-service" \
  --edge-router-roles "#aws-host"

```


### 创建ClientPC.jwt
```shell
[root@ip-10-1-1-79 ~]# ziti edge create identity user ClientPC \
  -a "nginx-clients" \
  -o ClientPC.jwt
Command "user" is deprecated, this command is deprecated, specifying identity type is no longer required
New identity ClientPC created with id: g6y0I.14bj
Enrollment expires at 2025-04-24T10:50:05.898Z

[root@ip-10-1-1-79 ~]# cat ClientPC.jwt
eyJhbGciOiJSUzI1NiIsImtpZCI6ImVjNmYyZmI2OGMyZWYxNmFmNDI5NzllZWMwYTMzZmMzYzIwYzRjN2UiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3ppdGktY29udHJvbGxlci5taW5namlhb2NmLmNvbTo2MjYyIiwic3ViIjoiWFNjcmp0bzNuUyIsImF1ZCI6WyIiXSwiZXhwIjoxNzQ1NTA2OTc2LCJqdGkiOiJjNWRlNjIwYS0xZDI3LTQyZjgtYTJhZC1mNTFiNDBlNjExYTMiLCJlbSI6Im90dCIsImN0cmxzIjpbInRsczp6aXRpLWNvbnRyb2xsZXIubWluZ2ppYW9jZi5jb206NjI2MiJdfQ.ikvNN6UDQ_UQ9uzCr0oYNOlL_T4G1GY_beaTrG-mfhbertAGELWIcuujhUgpW-QTkmTrOGjsOHP0zMvoS_9nTov3Nm9gOCuKO1RqjMY8KmKMrXcZhgFK7kdEK-VLK2VhMUpeXm45IfJLKigpoROWfXfc62wRSzvTENOCz97el0RRroMW8wQj0-LRw8YVHMfJZw9HE2D0BPfoiYe1S-WLyo9ZVv-iv0OpYqWFuVl2p4lJ-XQH06AYlYzbaLxpcEcv66Hy_GiTEZhrfpIpxh6N6SEvTDJD-Rrbm3t76R_L9dOgQIlH0NDT8Kc0bnC6auI6yN94Ju9I5rD5so6onSIMiow2LCBGta9JceEqXumluE7ZVppDeI7DVtzogEmOBsMlzBxI-NXcpsghcj3NjV3391YhSSojPxMl17iKBg9ausRzY3ciSi0QczX-zstTzHY6bHWsuNWFNRsXVIpI23pQHLPpbJ-JaZgF4jO7e4WFzI2md2i8ITh787qBcv5DNB5rra89_uinsOxzcvX6ipX4J8ebm5MlLNTAA9KBQCNnlQnTu37B0xat0ae0aZanbsWaMQmZWkGDQ-oYJgtzG2JSAZybbs0wJdEX7UrUZqoYnGEWgLmVWisIm2hW8ZY9KyZwdW8-0O8Jyl_hMzIuccAmnRCtQdcAZR3RxKyiwO-ORZA
```
